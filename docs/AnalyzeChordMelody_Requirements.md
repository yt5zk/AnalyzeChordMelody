
# AnalyzeChordMelody 要件定義書

## 1. プロジェクト概要

**プロジェクト名**: AnalyzeChordMelody

**目的**:  
AnalyzeChordMelodyは、音声ファイル（.wav形式）を解析し、楽曲内の和音（Chords）と単旋律（Melody）を自動的に判定・分類・リネームするシステムです。本システムは、音楽制作や音声分析の効率化を目的としています。

**背景**:  
音楽制作や音声分析の現場では、複数の楽器や音声トラックを管理・編集する際に、和音と単旋律の区別が重要です。手動での分類は時間と労力がかかるため、自動化されたシステムの需要が高まっています。

## 2. 目標

- `.wav`ファイルを自動的に解析し、和音と単旋律を判定する。
- 判定結果に基づき、ファイル名を適切にリネームする。
- Dockerを利用した環境構築により、再現性の高い運用を実現する。
- ロギング機能を備え、処理状況やエラーを記録する。

## 3. スコープ

### 3.1. 対象

- 入力: `.wav`形式の音声ファイル
- 出力: 判定結果に基づいてリネームされた`.wav`ファイル

### 3.2. 除外

- 音声ファイルの編集や加工（カット、フェードイン・アウト等）は対象外
- 和音と単旋律以外の判定（リズム、テンポ等）は対象外

## 4. 機能要件

### 4.1. ファイルの探索

- 指定されたディレクトリ内の全ての`.wav`ファイルを探索する。
- サブディレクトリ内のファイルも対象とする。

### 4.2. 音声ファイルの読み込みと前処理

- Essentiaライブラリを使用して音声ファイルを読み込む。
- 必要に応じてサンプリングレートの統一やノイズ除去を行う。

### 4.3. 特徴量の抽出

- 音声ファイルからピッチ（音高）情報を抽出する。
- 抽出した特徴量を基に和音と単旋律を判定する。

### 4.4. 判定ロジック

- 抽出したピッチ情報を解析し、和音（Chord）か単旋律（Melody）かを判定する。
- 判定基準は設定ファイル（`config.yaml`）で定義可能とする。

### 4.5. ファイルのリネーム

- 判定結果に基づき、ファイル名を以下のようにリネームする：
  - 和音ファイル: `_CHP.wav` へ変更
  - 単旋律ファイル: 変更なし

### 4.6. ロギング

- 処理の進行状況やエラーをログファイル（`analysis.log`）に記録する。
- ログレベルは設定ファイルで調整可能とする。

## 5. 非機能要件

### 5.1. パフォーマンス

- 大量のファイルを効率的に処理できる。
- 各ファイルの処理時間は平均してX秒以下を目標とする。（具体的な数値は要検討）

### 5.2. 可用性

- システムは24時間稼働可能とする。
- 障害発生時には適切なエラーハンドリングを行い、システムの安定性を確保する。

### 5.3. セキュリティ

- 処理対象のファイルは指定ディレクトリ内に限定する。
- 不正なファイルや悪意のあるコードの実行を防ぐため、入力ファイルの検証を行う。

### 5.4. 拡張性

- 判定ロジックやパラメータの変更が容易に行える設計とする。
- 将来的な機能追加（例: 他の音声形式への対応）を考慮する。

## 6. 技術要件

### 6.1. ソフトウェア

- **プログラミング言語**: Python 3.10
- **ライブラリ**:
  - Essentia
  - librosa
  - numpy
  - scipy
  - PyYAML
  - soundfile
- **コンテナ化**: Docker, Docker Compose

### 6.2. ハードウェア

- **サーバー環境**: Docker対応のLinux環境（ホストOSはApple Silicon Macであり、プラットフォームの互換性を考慮）
- **ストレージ**: 十分な容量のディスクスペース（具体的な容量は要検討）

### 6.3. 環境構築

- **Dockerfile**:
  - ベースイメージ: `mtgupf/essentia:latest`
  - 必要なシステムパッケージのインストール（build-essential, ffmpeg, python3-pip）
  - Pythonパッケージのインストール（`requirements.txt`）

- **docker-compose.yml**:
  - サービス定義: `audio_analysis`
  - ボリュームマウント:
    - ホストのプロジェクトディレクトリをコンテナ内の`/app`にマウント
    - ホストの`data`ディレクトリをコンテナ内の`/data`にマウント
  - プラットフォーム指定: `linux/amd64`（Apple Silicon Mac対応）
  - 環境変数設定: `PYTHONUNBUFFERED=1`

## 7. システムアーキテクチャ

ホストマシン (Apple Silicon Mac)
```
ホストマシン (Apple Silicon Mac)
│
├── プロジェクトディレクトリ/
│   ├── Dockerfile
│   ├── docker-compose.yml
│   ├── requirements.txt
│   ├── config.yaml
│   ├── main.py
│   ├── modules/
│   │   ├── file_finder.py
│   │   ├── audio_processor.py
│   │   ├── feature_extractor.py
│   │   ├── judge.py
│   │   ├── renamer.py
│   │   ├── config_loader.py
│   │   └── logger.py
│   ├── tests/
│   │   └── test_modules.py
│   └── data/
│       ├── Amulet - 62 BPM D# Min/Cymatics - Amulet - 62 BPM D# Min String_MLD.wav
│       ├── ... (その他の.wavファイル)
```
